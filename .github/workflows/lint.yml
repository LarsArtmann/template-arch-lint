# ğŸ”¥ Enterprise-Grade Linting Pipeline
# Enforces maximum code quality and architectural compliance
# Uses project's justfile commands for consistency with local development

name: ğŸ” Code Quality & Architecture Validation

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch: # Allow manual triggering

# Cancel in-progress runs on new pushes to same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Tool versions - matches justfile configuration
  GOLANGCI_VERSION: "v2.3.1"
  GO_ARCH_LINT_VERSION: "v1.12.0"

jobs:
  # ==============================================
  # Fast pre-checks to fail early if basic issues
  # ==============================================
  pre-checks:
    name: ğŸš¦ Pre-flight Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Validate Workflow Files
      run: |
        echo "Validating GitHub workflows syntax..."
        for file in .github/workflows/*.yml; do
          echo "âœ“ Checking $file"
          # Basic YAML syntax validation
          python3 -c "import yaml; yaml.safe_load(open('$file'))"
        done

    - name: ğŸ“ Check Critical Files
      run: |
        echo "Verifying required configuration files exist..."
        test -f .golangci.yml && echo "âœ“ .golangci.yml found" || exit 1
        test -f .go-arch-lint.yml && echo "âœ“ .go-arch-lint.yml found" || exit 1
        test -f justfile && echo "âœ“ justfile found" || exit 1
        test -f go.mod && echo "âœ“ go.mod found" || exit 1

  # ==============================================
  # Comprehensive linting across Go versions
  # ==============================================
  lint:
    name: ğŸ” Lint (Go ${{ matrix.go-version }})
    runs-on: ubuntu-latest
    needs: pre-checks
    timeout-minutes: 15

    strategy:
      fail-fast: false # Continue testing other versions even if one fails
      matrix:
        go-version: ['1.21', '1.22', '1.23', '1.24']

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Full history for better analysis

    - name: ğŸ—ï¸ Setup Go ${{ matrix.go-version }}
      uses: actions/setup-go@v5
      with:
        go-version: ${{ matrix.go-version }}
        cache: true
        cache-dependency-path: |
          go.sum
          go.mod

    - name: ğŸ“¦ Verify Go Installation
      run: |
        go version
        go env GOVERSION
        go env GOOS
        go env GOARCH

    - name: ğŸ“‹ Download Dependencies
      run: |
        go mod download
        go mod verify

    - name: ğŸ”§ Install Just Command Runner
      uses: extractions/setup-just@v2
      with:
        just-version: '1.36.0'

    - name: ğŸ“¦ Install Linting Tools
      run: |
        echo "Installing golangci-lint ${GOLANGCI_VERSION}..."
        go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@${GOLANGCI_VERSION}

        echo "Installing go-arch-lint ${GO_ARCH_LINT_VERSION}..."
        go install github.com/fe3dback/go-arch-lint@${GO_ARCH_LINT_VERSION}

        echo "Installing additional tools..."
        go install golang.org/x/tools/cmd/goimports@latest
        go install github.com/a-h/templ/cmd/templ@latest

        # Verify installations
        golangci-lint version
        go-arch-lint version
        just --version

    - name: ğŸ“ Filename Verification
      run: |
        echo "ğŸ” Checking for problematic filenames..."
        just lint-files

    - name: ğŸ—ï¸ Architecture Validation
      run: |
        echo "ğŸ” Validating architectural boundaries..."
        just lint-arch

    - name: ğŸ“ Code Quality Analysis
      run: |
        echo "ğŸ” Running comprehensive code quality checks..."
        just lint-code

    - name: ğŸ”§ Template Generation
      run: |
        echo "ğŸ” Generating templates to verify they compile..."
        just templ

    - name: ğŸš€ Build Verification
      run: |
        echo "ğŸ” Verifying project builds successfully..."
        go build ./...

    - name: ğŸ“Š Generate Linting Reports
      if: matrix.go-version == '1.24' # Only generate reports on latest version
      run: |
        echo "ğŸ“Š Generating detailed reports..."
        just report

    - name: ğŸ“¤ Upload Linting Reports
      if: matrix.go-version == '1.24'
      uses: actions/upload-artifact@v4
      with:
        name: lint-reports-${{ github.run_number }}
        path: reports/
        retention-days: 30

  # ==============================================
  # Security-focused linting
  # ==============================================
  security-scan:
    name: ğŸ”’ Security Analysis
    runs-on: ubuntu-latest
    needs: pre-checks
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Setup Go 1.24
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'
        cache: true
        cache-dependency-path: go.sum

    - name: ğŸ”§ Install Just and Tools
      run: |
        # Install just
        curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

        # Install linting tools
        go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@${GOLANGCI_VERSION}

    - name: ğŸ”’ Security Linting
      run: |
        echo "ğŸ”’ Running security-focused analysis..."
        just lint-security

    - name: ğŸ›¡ï¸ Go Vulnerability Check
      run: |
        echo "ğŸ›¡ï¸ Checking for known vulnerabilities..."
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./...

  # ==============================================
  # Summary job that requires all linting to pass
  # ==============================================
  lint-success:
    name: âœ… Linting Complete
    runs-on: ubuntu-latest
    needs: [pre-checks, lint, security-scan]
    timeout-minutes: 2

    steps:
    - name: ğŸ‰ All Linting Passed
      run: |
        echo "ğŸ‰ All linting checks completed successfully!"
        echo "âœ… Pre-flight checks passed"
        echo "âœ… Code quality validation passed across all Go versions"
        echo "âœ… Architecture boundaries validated"
        echo "âœ… Security analysis completed"
        echo ""
        echo "ğŸš€ Code is ready for deployment!"
